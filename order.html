<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order a Custom Keychain</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#1f2937;--muted:#64748b;--accent:#0ea5e9}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    .container{max-width:860px;margin:32px auto;padding:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:24px}
    h1{margin:0 0 8px;font-size:1.9rem}
    p.sub{margin:0 0 16px;color:var(--muted)}
    nav{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 16px}
    nav a{display:inline-block;text-decoration:none;background:#e2f2fd;padding:8px 12px;border-radius:10px;color:#0b4e6d;font-weight:600}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;background:#fff}
    .row{display:grid;gap:12px}
    @media(min-width:640px){.row.two{grid-template-columns:1fr 1fr}}
    .hidden{display:none}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    button,.btn{display:inline-block;margin-top:12px;background:var(--accent);color:#fff;border:0;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;text-decoration:none}
    #status{margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Custom Keychain Order</h1>
      <p class="sub">Maple Wood only ‚Ä¢ Name tier starts at $10</p>
      <nav><a href="./index.html">Home</a><a href="./bulk.html">Bulk (6+)</a><a href="./contact.html">Write to Us</a></nav>

      <form id="orderForm" novalidate>
        <div class="row two">
          <div>
            <label for="customerName">Full name *</label>
            <input id="customerName" type="text" required />
          </div>
          <div>
            <label for="email">Email *</label>
            <input id="email" type="email" required />
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="tier">Keychain type *</label>
            <select id="tier" required>
              <option value="name">Name only ($10)</option>
              <option value="emoji">Name + Emoji ($15)</option>
              <option value="photo">Photo engraving ($25)</option>
            </select>
          </div>
        </div>

        <label for="nameText">Name to engrave *</label>
        <input id="nameText" type="text" maxlength="20" required />

        <div id="emojiGroup" class="hidden">
          <label for="emoji">Choose an emoji *</label>
          <select id="emoji">
            <option value="‚≠ê">Star ‚≠ê</option>
            <option value="‚öΩ">Soccer ‚öΩ</option>
            <option value="üèÄ">Basketball üèÄ</option>
            <option value="üêæ">Paw üêæ</option>
            <option value="üê∂">Dog üê∂</option>
            <option value="üê±">Cat üê±</option>
            <option value="üéì">Graduation üéì</option>
            <option value="ü©∫">Doctor ü©∫</option>
            <option value="‚öôÔ∏è">Engineer ‚öôÔ∏è</option>
            <option value="üéµ">Music üéµ</option>
            <option value="custom">Custom (enter below)</option>
          </select>
          <div id="customEmojiBox" class="hidden">
            <label for="customEmoji">Custom emoji description *</label>
            <input id="customEmoji" type="text" placeholder="e.g., Dragon symbol" />
          </div>
        </div>

        <div id="photoGroup" class="hidden">
          <label for="photoLink">Photo link (optional)</label>
          <input id="photoLink" type="url" placeholder="Paste a Google Drive/Dropbox/Instagram link" />
          <p class="note">If you don‚Äôt have a link, submit your order and then <b>reply to our confirmation email</b> with your photo.</p>
        </div>

        <label for="fulfillment">Pickup / Delivery *</label>
        <select id="fulfillment" required>
          <option value="pickup_roundrock">Pickup ‚Äî Round Rock</option>
          <option value="delivery">Delivery</option>
        </select>
        <p class="note">Delivery fees are applied on Stripe checkout (you've already set them).</p>

        <div id="addressGroup" class="hidden"  class="hidden">
          <div class="row two">
            <div><label for="addr1">Address line 1 *</label><input id="addr1" type="text" /></div>
            <div><label for="addr2">Address line 2 (optional)</label><input id="addr2" type="text" /></div>
          </div>
          <div class="row two">
            <div><label for="city">City *</label><input id="city" type="text" /></div>
            <div><label for="state">State *</label><input id="state" type="text" maxlength="2" placeholder="TX" /></div>
          </div>
          <div class="row two">
            <div><label for="zip">ZIP code *</label><input id="zip" type="text" /></div>
            <div></div>
          </div>
        </div>

        <label for="material">Material</label>
        <input id="material" value="Maple Wood" readonly />

        <button id="submitPayBtn" type="submit">Submit &amp; Pay with Stripe</button>
        <div id="status" aria-live="polite"></div>
      </form>

      <p class="note">Having trouble? Email us directly: <a href="mailto:ponugotibiz@gmail.com">ponugotibiz@gmail.com</a></p>
      <a class="btn back-canva" target="_blank" rel="noopener">Back to Grit Over Grades ‚Üó</a>
    </div>
  </div>

  <script>
    // Config
    const FORM_ENDPOINTS = {
      order: "https://formspree.io/f/xkgvybab",
    };
    const CANVA_SITE_URL = "https://gritovergrades.com"; // back button target
    const STRIPE_LINKS = {
      // Use these for pickup (Round Rock); already set from your previous links
      pickup_roundrock: {
        name: "https://buy.stripe.com/28EcN5f9y7p20E3dKobsc03",
        emoji: "https://buy.stripe.com/4gMbJ1gdC24IaeD21Gbsc02",
        photo: "https://buy.stripe.com/8x29ATe5u10EgD1fSwbsc01"
      },
      // TODO: Paste your Delivery-specific Payment Links below if you want the price to reflect delivery automatically.
      // If left empty, we'll fall back to the pickup links and the customer can select delivery on Stripe.
      delivery: {
        name: "",   // e.g., "https://buy.stripe.com/..."
        emoji: "",  // e.g., "https://buy.stripe.com/..."
        photo: ""   // e.g., "https://buy.stripe.com/..."
      },
      // Fallback (legacy) per-tier links if needed
      name: "https://buy.stripe.com/28EcN5f9y7p20E3dKobsc03",
      emoji: "https://buy.stripe.com/4gMbJ1gdC24IaeD21Gbsc02",
      photo: "https://buy.stripe.com/8x29ATe5u10EgD1fSwbsc01"
    };

    function setBackLinks(){
      document.querySelectorAll('.back-canva').forEach(a => a.href = CANVA_SITE_URL);
    }
    setBackLinks();

    async function sendToFormspree(kind, payload){
      const url = FORM_ENDPOINTS[kind];
      const res = await fetch(url, {
        method: "POST",
        headers: { "Accept":"application/json", "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        let msg = "Submission failed.";
        try{ const j = await res.json(); if(j && j.errors && j.errors.length){ msg = j.errors.map(e=>e.message).join("; "); } }catch{}
        throw new Error(msg + " (HTTP " + res.status + ")");
      }
      return await res.json();
    }

    // UI refs
    const form = document.getElementById('orderForm');
    const tierEl=document.getElementById('tier');
    const emojiGroup=document.getElementById('emojiGroup');
    const photoGroup=document.getElementById('photoGroup');
    const emojiEl=document.getElementById('emoji');
    const customEmojiBox=document.getElementById('customEmojiBox');
    const fulfillmentEl=document.getElementById('fulfillment');
    const addressGroup=document.getElementById('addressGroup');
    const addr1=document.getElementById('addr1');
    const city=document.getElementById('city');
    const state=document.getElementById('state');
    const zip=document.getElementById('zip');
    const statusBox=document.getElementById('status');

    function unitPriceForTier(t){ return t==='name'?10 : t==='emoji'?15 : t==='photo'?25 : 0; }
    function deliveryFee(t){ return 0; } // not used; final fees shown on Stripe

    function updateVisibility(){
      const t=tierEl.value;
      emojiGroup.classList.toggle('hidden', t!=='emoji');
      photoGroup.classList.toggle('hidden', t!=='photo');
    }
    function updateCustomEmoji(){
      customEmojiBox.classList.toggle('hidden', emojiEl.value!=='custom');
      document.getElementById('customEmoji').required = (emojiEl.value==='custom');
    }
    function updateFulfillment(){
      const need = (fulfillmentEl.value!=='pickup_roundrock');
      addressGroup.classList.toggle('hidden', !need);
      addr1.required=city.required=state.required=zip.required = need;
    }
    tierEl.addEventListener('change', updateVisibility);
    emojiEl.addEventListener('change', updateCustomEmoji);
    fulfillmentEl.addEventListener('change', updateFulfillment);
    updateVisibility(); updateCustomEmoji(); updateFulfillment();

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusBox.className=''; statusBox.textContent='';

      const name=document.getElementById('customerName').value.trim();
      const email=document.getElementById('email').value.trim();
      const tier=tierEl.value;
      const nameText=document.getElementById('nameText').value.trim();
      if(!name || !email || !tier || !nameText){ statusBox.className='error'; statusBox.textContent='Please complete all required fields.'; return; }

      let emojiOrPhoto='N/A';
      if(tier==='emoji'){
        emojiOrPhoto = (emojiEl.value==='custom') ? ('Custom: ' + (document.getElementById('customEmoji').value.trim() || '(not specified)')) : emojiEl.value;
      }
      if(tier==='photo'){
        const link=(document.getElementById('photoLink').value||'').trim();
        emojiOrPhoto = link ? link : 'Customer will email photo after submission';
      }

      const fulfillMap={pickup_roundrock:'Pickup ‚Äî Round Rock', delivery:'Delivery'};
      const fulfillLabel=fulfillMap[fulfillmentEl.value]||'Pickup';
      const needsAddress=(fulfillmentEl.value!=='pickup_roundrock'); let address=null;
      if(needsAddress){
        if(!addr1.value.trim()||!city.value.trim()||!state.value.trim()||!zip.value.trim()){
          statusBox.className='error'; statusBox.textContent='Please complete the address for delivery/shipping.'; return;
        }
        address={ line1:addr1.value.trim(), line2:(document.getElementById('addr2').value||'').trim(), city:city.value.trim(), state:state.value.trim(), zip:zip.value.trim() };
      }

      // Build payload
      const qty = 1;
      const unit = unitPriceForTier(tier); const fee = 0;
      const estimated=(unit*qty+fee).toFixed(2);
      const tierLabel = tier==='name' ? 'Name only ($10)' : (tier==='emoji' ? 'Name + Emoji ($15)' : 'Photo engraving ($25)');
      const payload={ form:'order', to:'ponugotibiz@gmail.com', customer_name:name, customer_email:email, tier:tierLabel, quantity:qty, name_to_engrave:nameText, emoji_or_photo:emojiOrPhoto, material:'Maple Wood', fulfillment:fulfillLabel, address:address, delivery_fee:fee, estimated_total_before_tax:estimated };

      // Determine Stripe link
      let payUrl = (STRIPE_LINKS[fulfillmentEl.value] && STRIPE_LINKS[fulfillmentEl.value][tier]) || STRIPE_LINKS[tier] || null;
      if(payUrl && email){
        const join = payUrl.includes('?') ? '&' : '?';
        payUrl = payUrl + join + 'prefilled_email=' + encodeURIComponent(email);
      }

      try{
        await sendToFormspree('order', payload);
        if(payUrl){ window.location.href = payUrl; }
        else { statusBox.className='error'; statusBox.textContent='Payment link not set for this tier.'; }
      }catch(err){
        statusBox.className='error'; statusBox.textContent='Could not submit: ' + err.message;
      }
    });
  </script>
</body>
</html>
